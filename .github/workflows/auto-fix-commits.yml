name: Auto-Fix Commit Messages

on:
  workflow_run:
    workflows: ["Commit Message Lint"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-fix-commits:
    name: Squash and Fix Commit Messages
    # Only run when commitlint fails on a pull_request event
    if: |
      github.event.workflow_run.conclusion == 'failure' &&
      github.event.workflow_run.event == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Debug workflow_run event
        run: |
          echo "Event name: ${{ github.event_name }}"
          echo "Workflow run conclusion: ${{ github.event.workflow_run.conclusion }}"
          echo "Workflow run event: ${{ github.event.workflow_run.event }}"
          echo "Head branch: ${{ github.event.workflow_run.head_branch }}"
          echo "Head SHA: ${{ github.event.workflow_run.head_sha }}"

      - name: Get PR information
        id: get-pr
        uses: actions/github-script@v7
        with:
          script: |
            const headBranch = '${{ github.event.workflow_run.head_branch }}';
            const headSha = '${{ github.event.workflow_run.head_sha }}';

            core.info(`Looking for PR with head branch: ${headBranch}, sha: ${headSha}`);

            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${headBranch}`,
              state: 'open'
            });

            if (prs.data.length === 0) {
              core.setFailed('No open PR found for this branch');
              return;
            }

            const pr = prs.data[0];
            core.info(`Found PR #${pr.number}: ${pr.title}`);

            const pattern = /^(feat|fix|docs|refactor|perf|test|chore|ci|style)(\(.+\))?!?: .+/;
            if (!pattern.test(pr.title)) {
              core.setFailed(`PR title does not follow conventional commits: ${pr.title}`);
              return;
            }

            if (pr.head.repo.full_name !== pr.base.repo.full_name) {
              core.setFailed('Cannot auto-fix commits from forked repositories');
              return;
            }

            core.setOutput('pr_number', pr.number);
            core.setOutput('pr_title', pr.title);
            core.setOutput('head_branch', pr.head.ref);
            core.setOutput('base_branch', pr.base.ref);
            core.setOutput('head_sha', pr.head.sha);

      - name: Checkout PR branch
        uses: actions/checkout@v6
        with:
          ref: ${{ steps.get-pr.outputs.head_branch }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Count commits ahead of base
        id: count-commits
        run: |
          BASE_BRANCH="${{ steps.get-pr.outputs.base_branch }}"
          git fetch origin "$BASE_BRANCH"
          COMMIT_COUNT=$(git rev-list --count "origin/$BASE_BRANCH..HEAD")
          echo "commit_count=$COMMIT_COUNT" >> $GITHUB_OUTPUT
          echo "Found $COMMIT_COUNT commits ahead of $BASE_BRANCH"

      - name: Squash commits
        id: squash-commits
        if: steps.count-commits.outputs.commit_count > 1
        run: |
          BASE_BRANCH="${{ steps.get-pr.outputs.base_branch }}"
          PR_TITLE="${{ steps.get-pr.outputs.pr_title }}"
          COMMIT_COUNT="${{ steps.count-commits.outputs.commit_count }}"

          echo "Squashing $COMMIT_COUNT commits into one..."

          git reset --soft "origin/$BASE_BRANCH"

          git commit -m "$PR_TITLE

          Squashed $COMMIT_COUNT commits automatically by GitHub Actions.
          This ensures the commit message follows conventional commits format.

          Co-Authored-By: github-actions[bot] <github-actions[bot]@users.noreply.github.com>"

          echo "Squash complete!"
          echo "changes_made=true" >> $GITHUB_OUTPUT

      - name: Fix single commit message
        id: fix-single-commit
        if: steps.count-commits.outputs.commit_count == 1
        run: |
          PR_TITLE="${{ steps.get-pr.outputs.pr_title }}"
          CURRENT_MSG=$(git log -1 --format=%B)

          FIRST_LINE=$(echo "$CURRENT_MSG" | head -1)
          if [ "$FIRST_LINE" = "$PR_TITLE" ]; then
            echo "Commit message already matches PR title, no fix needed"
            echo "changes_made=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Amending commit message to match PR title..."

          BODY=$(echo "$CURRENT_MSG" | tail -n +3 | awk '{$1=$1};1')

          if [ -n "$BODY" ]; then
            git commit --amend -m "$PR_TITLE

          $BODY"
          else
            git commit --amend -m "$PR_TITLE

          Commit message auto-fixed by GitHub Actions.

          Co-Authored-By: github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
          fi
          echo "changes_made=true" >> $GITHUB_OUTPUT

      - name: Force push fixed commits
        id: push-commits
        if: steps.squash-commits.outputs.changes_made == 'true' || steps.fix-single-commit.outputs.changes_made == 'true'
        continue-on-error: true
        run: |
          HEAD_BRANCH="${{ steps.get-pr.outputs.head_branch }}"
          HEAD_SHA="${{ steps.get-pr.outputs.head_sha }}"
          echo "Force pushing to $HEAD_BRANCH..."
          if git push origin "$HEAD_BRANCH" --force-with-lease="$HEAD_BRANCH:$HEAD_SHA"; then
            echo "push_success=true" >> $GITHUB_OUTPUT
          else
            echo "push_success=false" >> $GITHUB_OUTPUT
            echo "::warning::Force push failed - likely due to branch protection rules"
          fi

      - name: Comment on PR (success)
        if: steps.push-commits.outputs.push_success == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.get-pr.outputs.pr_number }};
            const commitCount = ${{ steps.count-commits.outputs.commit_count }};
            const prTitle = `${{ steps.get-pr.outputs.pr_title }}`;

            let message;
            if (commitCount > 1) {
              message = [
                '### Commit Messages Auto-Fixed',
                '',
                'The commitlint check failed because one or more commit messages did not follow [Conventional Commits](https://www.conventionalcommits.org/) format.',
                '',
                `**Action taken** - Squashed ${commitCount} commits into a single commit using the PR title as the commit message.`,
                '',
                '**New commit message**',
                '```',
                prTitle,
                '```',
                '',
                'The PR branch has been force-pushed with the fixed commit. If you had local changes, you may need to `git pull --rebase`.'
              ].join('\n');
            } else {
              message = [
                '### Commit Message Auto-Fixed',
                '',
                'The commitlint check failed because the commit message did not follow [Conventional Commits](https://www.conventionalcommits.org/) format.',
                '',
                '**Action taken** - Amended the commit message to use the PR title.',
                '',
                '**New commit message**',
                '```',
                prTitle,
                '```',
                '',
                'The PR branch has been force-pushed with the fixed commit. If you had local changes, you may need to `git pull --rebase`.'
              ].join('\n');
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: message
            });

      - name: Comment on PR (manual fix needed)
        if: (steps.squash-commits.outputs.changes_made == 'true' || steps.fix-single-commit.outputs.changes_made == 'true') && steps.push-commits.outputs.push_success != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.get-pr.outputs.pr_number }};
            const commitCount = ${{ steps.count-commits.outputs.commit_count }};
            const prTitle = `${{ steps.get-pr.outputs.pr_title }}`;

            const message = [
              '### Manual Commit Message Fix Required',
              '',
              'The commitlint check failed because one or more commit messages did not follow [Conventional Commits](https://www.conventionalcommits.org/) format.',
              '',
              '**Automatic fix could not be applied** due to branch protection rules that prevent force-pushing.',
              '',
              '**Please run the following commands locally to fix:**',
              '',
              '```bash',
              '# Fetch latest changes',
              'git fetch origin',
              '',
              `# Interactive rebase to squash ${commitCount} commits`,
              `git rebase -i origin/${{ steps.get-pr.outputs.base_branch }}`,
              '',
              '# In the editor, change all "pick" to "squash" (or "s") except the first one',
              '# Save and close the editor',
              '',
              '# When prompted for the commit message, use:',
              prTitle,
              '',
              '# Force push the fixed commits',
              `git push origin ${{ steps.get-pr.outputs.head_branch }} --force-with-lease`,
              '```',
              '',
              '**Or use this one-liner:**',
              '```bash',
              `git fetch origin && git reset --soft origin/${{ steps.get-pr.outputs.base_branch }} && git commit -m "${prTitle}" && git push --force-with-lease`,
              '```',
              '',
              '---',
              '',
              '> **Note:** Repository admins can enable automatic fixing by allowing force-pushes from GitHub Actions in the branch protection settings.'
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: message
            });
