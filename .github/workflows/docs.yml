name: Documentation

# Auto-generate and publish API documentation and Interactive Playground
# Triggered after Build & SonarCloud completes to reuse build artifacts
on:
  workflow_run:
    workflows: ["Build & SonarCloud"]
    types:
      - completed
    branches:
      - master
  workflow_dispatch:

concurrency:
  group: "pages"
  cancel-in-progress: false

permissions:
  contents: read
  pages: write
  id-token: write
  actions: read  # Required to download artifacts from other workflows

env:
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
  DOTNET_NOLOGO: true

jobs:
  build-docs:
    name: Build Documentation and Playground
    runs-on: ubuntu-latest
    # Only run if the triggering workflow succeeded (or if manually dispatched)
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET 10.0
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'

    - name: Install DocFX
      run: dotnet tool install --global docfx || true

    - name: Download build artifacts from Build workflow
      uses: dawidd6/action-download-artifact@v6
      with:
        workflow: Build & SonarCloud
        workflow_conclusion: success
        name: build-output-${{ github.event.workflow_run.head_sha || github.sha }}
        path: .
        if_no_artifact_found: warn

    - name: Restore dependencies (fallback if no artifacts)
      run: |
        # Check if build artifacts exist, if not do a fresh build
        if [ ! -d "src/bin/Release" ]; then
          echo "No build artifacts found, performing fresh build..."
          dotnet restore
          dotnet build -c Release --no-restore -p:TreatWarningsAsErrors=false
        else
          echo "Using build artifacts from Build & SonarCloud workflow"
          # Still need to restore for DocFX metadata extraction
          dotnet restore
        fi

    - name: Build DocFX documentation
      run: docfx docfx.json

    - name: Restore Playground dependencies
      run: dotnet restore src/AiDotNet.Playground/AiDotNet.Playground.csproj

    - name: Build Blazor WASM Playground
      run: dotnet publish src/AiDotNet.Playground/AiDotNet.Playground.csproj -c Release -o _playground

    - name: Copy Playground to documentation site
      run: |
        mkdir -p _site/playground
        cp -r _playground/wwwroot/* _site/playground/
        # Update base href for the playground subdirectory
        sed -i 's|<base href="/" />|<base href="/AiDotNet/playground/" />|g' _site/playground/index.html

    # Note: DocFX generates the landing page from docs/index.md
    # The full documentation site includes: Getting Started, Tutorials, Reference, API, and Community sections
    # Navigation is configured via toc.yml files

    - name: Setup Pages
      uses: actions/configure-pages@v5

    - name: Upload Pages artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: _site/

    - name: Documentation summary
      run: |
        echo "## Documentation Build Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Documentation and Playground built successfully" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Links" >> $GITHUB_STEP_SUMMARY
        echo "- [Documentation Home](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/)" >> $GITHUB_STEP_SUMMARY
        echo "- [API Reference](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/api/)" >> $GITHUB_STEP_SUMMARY
        echo "- [Interactive Playground](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/playground/)" >> $GITHUB_STEP_SUMMARY

  deploy:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: build-docs
    # Only deploy from master branch
    if: (github.event_name == 'workflow_dispatch' && github.ref == 'refs/heads/master') || (github.event_name == 'workflow_run' && github.event.workflow_run.head_branch == 'master')

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
