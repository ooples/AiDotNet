name: Documentation

# Auto-generate and publish API documentation and Interactive Playground
# Triggered after Build & SonarCloud completes to reuse build artifacts
on:
  workflow_run:
    workflows: ["Build & SonarCloud"]
    types:
      - completed
    branches:
      - master
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pages: write
  id-token: write
  actions: read  # Required to download artifacts from other workflows

env:
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
  DOTNET_NOLOGO: true

jobs:
  build-docs:
    name: Build Documentation and Playground
    runs-on: ubuntu-latest
    # Only run if the triggering workflow succeeded (or if manually dispatched)
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    steps:
    - name: Checkout code
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

    - name: Setup .NET 10.0
      uses: actions/setup-dotnet@baa11fbfe1d6520db94683bd5c7a3818018e4309 # v5
      with:
        dotnet-version: '10.0.x'

    - name: Install DocFX
      run: dotnet tool install --global docfx || true

    - name: Download build artifacts from Build workflow
      uses: dawidd6/action-download-artifact@20319c5641d495c8a52e688b7dc5fada6c3a9fbc # v8
      with:
        workflow: Build & SonarCloud
        workflow_conclusion: success
        name: build-output-${{ github.event.workflow_run.head_sha || github.sha }}
        path: .
        if_no_artifact_found: warn

    - name: Restore dependencies (fallback if no artifacts)
      run: |
        # Check if build artifacts exist, if not do a fresh build
        if [ ! -d "src/bin/Release" ]; then
          echo "No build artifacts found, performing fresh build..."
          dotnet restore
          dotnet build -c Release --no-restore -p:TreatWarningsAsErrors=false
        else
          echo "Using build artifacts from Build & SonarCloud workflow"
          # Still need to restore for DocFX metadata extraction
          dotnet restore
        fi

    - name: Build DocFX documentation
      run: docfx docfx.json

    - name: Restore Playground dependencies
      run: dotnet restore src/AiDotNet.Playground/AiDotNet.Playground.csproj

    - name: Build Blazor WASM Playground
      run: dotnet publish src/AiDotNet.Playground/AiDotNet.Playground.csproj -c Release -o _playground

    - name: Copy Playground to documentation site
      run: |
        mkdir -p _site/playground
        cp -r _playground/wwwroot/* _site/playground/
        # Update base href for the playground subdirectory
        sed -i 's|<base href="/" />|<base href="/AiDotNet/playground/" />|g' _site/playground/index.html

    # Note: DocFX generates the landing page from docs/index.md
    # The full documentation site includes: Getting Started, Tutorials, Reference, API, and Community sections
    # Navigation is configured via toc.yml files

    - name: Upload documentation artifact
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
      with:
        name: documentation
        path: _site/

    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@4f9cc6602d3f66b9c108549d475ec49e8ef4d45e # v4
      if: (github.event_name == 'workflow_dispatch' && github.ref == 'refs/heads/master') || (github.event_name == 'workflow_run' && github.event.workflow_run.head_branch == 'master')
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./_site
        force_orphan: true

    - name: Documentation summary
      run: |
        echo "## Documentation Build Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Documentation and Playground built successfully" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Links" >> $GITHUB_STEP_SUMMARY
        echo "- [Documentation Home](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/)" >> $GITHUB_STEP_SUMMARY
        echo "- [API Reference](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/api/)" >> $GITHUB_STEP_SUMMARY
        echo "- [Interactive Playground](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/playground/)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "1. Enable GitHub Pages in repository settings" >> $GITHUB_STEP_SUMMARY
        echo "2. Set source to 'gh-pages' branch" >> $GITHUB_STEP_SUMMARY
        echo "3. Documentation will be available at the links above" >> $GITHUB_STEP_SUMMARY
