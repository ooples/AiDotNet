{
  "id": "PRR_kwDOKSXUF87MAsFe",
  "author": {
    "login": "coderabbitai"
  },
  "authorAssociation": "CONTRIBUTOR",
  "body": "**Actionable comments posted: 10**\n\n<details>\n<summary>ΓÖ╗∩╕Å Duplicate comments (5)</summary><blockquote>\n\n<details>\n<summary>src/RetrievalAugmentedGeneration/DocumentStores/MilvusDocumentStore.cs (1)</summary><blockquote>\n\n`145-153`: **DonΓÇÖt mutate stored documents when returning query results.**\n\nThis selector still sets `RelevanceScore`/`HasRelevanceScore` on the objects held in `_documents`, so every query leaves stale scores visible to `GetById`/future searches. The earlier review flagged this; please return shallow copies that carry the score instead of mutating the cached instances.\n\n</blockquote></details>\n<details>\n<summary>src/RetrievalAugmentedGeneration/DocumentStores/DocumentStoreBase.cs (1)</summary><blockquote>\n\n`3-5`: **Remove duplicate using directive.**\n\nThe `using AiDotNet.Interfaces;` appears on both lines 3 and 5.\n\n\n\nApply this diff:\n```diff\n using AiDotNet.Helpers;\n using AiDotNet.Interfaces;\n using AiDotNet.LinearAlgebra;\n-using AiDotNet.Interfaces;\n using AiDotNet.RetrievalAugmentedGeneration.Models;\n```\n\n</blockquote></details>\n<details>\n<summary>src/RetrievalAugmentedGeneration/DocumentStores/ChromaDBDocumentStore.cs (1)</summary><blockquote>\n\n`90-115`: **Validate embedding dimensions in batch operations.**\n\nWhen processing the first batch, `DocumentStoreBase` validation is skipped (DocumentCount is 0), allowing mixed-length embeddings to be cached. Later similarity calculations will fail when encountering mismatched dimensions.\n\n\n\nApply this diff:\n\n```diff\n protected override void AddBatchCore(IList<VectorDocument<T>> vectorDocuments)\n {\n     if (vectorDocuments.Count == 0) return;\n     \n     if (_vectorDimension == 0)\n         _vectorDimension = vectorDocuments[0].Embedding.Length;\n\n     foreach (var vd in vectorDocuments)\n+    {\n+        if (vd.Embedding.Length != _vectorDimension)\n+            throw new ArgumentException(\n+                $\"Vector dimension mismatch. Expected {_vectorDimension}, got {vd.Embedding.Length}\",\n+                nameof(vectorDocuments));\n+\n         _cache[vd.Document.Id] = vd;\n+    }\n```\n\n</blockquote></details>\n<details>\n<summary>src/RetrievalAugmentedGeneration/DocumentStores/RedisVLDocumentStore.cs (1)</summary><blockquote>\n\n`172-187`: **Apply metadata filters and set HasRelevanceScore flag.**\n\nThe implementation has three issues:\n\n1. **Missing metadata filtering**: The `metadataFilters` parameter is ignored. Documents should be filtered using the `MatchesFilters` helper from the base class.\n2. **Missing relevance flag**: `HasRelevanceScore` is never set to `true`, breaking downstream code that checks this flag.\n3. **Unsafe type conversion**: `Convert.ToDouble` will throw for non-`IConvertible` types. Use `NumOps.ToDouble()` instead.\n\n\n\nApply this diff:\n\n```diff\n protected override IEnumerable<Document<T>> GetSimilarCore(Vector<T> queryVector, int topK, Dictionary<string, object> metadataFilters)\n {\n     var results = new List<(Document<T> doc, T score)>();\n\n     foreach (var vd in _store.Values)\n     {\n+        if (!MatchesFilters(vd.Document, metadataFilters))\n+            continue;\n+\n         var similarity = StatisticsHelper<T>.CosineSimilarity(queryVector, vd.Embedding);\n         vd.Document.RelevanceScore = similarity;\n+        vd.Document.HasRelevanceScore = true;\n         results.Add((vd.Document, similarity));\n     }\n\n     return results\n-        .OrderByDescending(x => Convert.ToDouble(x.score))\n+        .OrderByDescending(x => NumOps.ToDouble(x.score))\n         .Take(topK)\n         .Select(x => x.doc);\n }\n```\n\n</blockquote></details>\n<details>\n<summary>src/RetrievalAugmentedGeneration/DocumentStores/AzureSearchDocumentStore.cs (1)</summary><blockquote>\n\n`53-68`: **Validate embedding dimensions before adding to batch.**\n\nWhen the first batch is added, `DocumentStoreBase` can't enforce dimension checks (DocumentCount is 0), so mixed-length embeddings can slip through and later break similarity calculations.\n\n\n\nApply this diff:\n\n```diff\n protected override void AddBatchCore(IList<VectorDocument<T>> vectorDocuments)\n {\n     if (vectorDocuments.Count == 0)\n         return;\n\n     if (_documents.Count == 0)\n     {\n         _vectorDimension = vectorDocuments[0].Embedding.Length;\n     }\n\n     foreach (var vectorDoc in vectorDocuments)\n     {\n+        if (vectorDoc.Embedding.Length != _vectorDimension)\n+            throw new ArgumentException(\n+                $\"Vector dimension mismatch. Expected {_vectorDimension}, got {vectorDoc.Embedding.Length}\",\n+                nameof(vectorDocuments));\n+\n         _documents[vectorDoc.Document.Id] = vectorDoc;\n         IndexMetadata(vectorDoc.Document);\n     }\n }\n```\n\n</blockquote></details>\n\n</blockquote></details>\n\n<details>\n<summary>≡ƒº╣ Nitpick comments (2)</summary><blockquote>\n\n<details>\n<summary>src/RetrievalAugmentedGeneration/DocumentStores/WeaviateDocumentStore.cs (1)</summary><blockquote>\n\n`188-197`: **Prevent cached documents from retaining stale relevance scores.**\n\nAs with the other stores, this code mutates `_documents` when setting `RelevanceScore`/`HasRelevanceScore`. Please return copies so the stored instances remain score-free between queries.\n\n</blockquote></details>\n<details>\n<summary>src/RetrievalAugmentedGeneration/DocumentStores/HybridDocumentStore.cs (1)</summary><blockquote>\n\n`209-212`: **Consider avoiding double dictionary lookup.**\n\nLines 210-211 call `ContainsKey` then index `combinedScores` twice for each document, causing redundant lookups. While clear and readable, this could be optimized if performance matters for large result sets.\n\n\n\nOptional refactor:\n\n```diff\n     var results = allDocuments\n-        .Where(doc => combinedScores.ContainsKey(doc.Id))\n-        .OrderByDescending(doc => combinedScores[doc.Id])\n+        .Where(doc => combinedScores.TryGetValue(doc.Id, out _))\n+        .OrderByDescending(doc => combinedScores.TryGetValue(doc.Id, out var score) ? score : NumOps.Zero)\n         .Take(topK)\n```\n\nHowever, the current implementation is more readable and the performance difference is negligible for typical topK values.\n\n</blockquote></details>\n\n</blockquote></details>\n\n<details>\n<summary>≡ƒô£ Review details</summary>\n\n**Configuration used**: CodeRabbit UI\n\n**Review profile**: CHILL\n\n**Plan**: Pro\n\n<details>\n<summary>≡ƒôÑ Commits</summary>\n\nReviewing files that changed from the base of the PR and between aaf7a4a8027b8bb88ec10c6b3b8f1d9ba7d9e40e and e972697ed5a758045091402fb3f80cadcdfa8829.\n\n</details>\n\n<details>\n<summary>≡ƒôÆ Files selected for processing (14)</summary>\n\n* `src/RetrievalAugmentedGeneration/DocumentStores/AzureSearchDocumentStore.cs` (1 hunks)\n* `src/RetrievalAugmentedGeneration/DocumentStores/ChromaDBDocumentStore.cs` (1 hunks)\n* `src/RetrievalAugmentedGeneration/DocumentStores/DocumentStoreBase.cs` (11 hunks)\n* `src/RetrievalAugmentedGeneration/DocumentStores/ElasticsearchDocumentStore.cs` (1 hunks)\n* `src/RetrievalAugmentedGeneration/DocumentStores/FAISSDocumentStore.cs` (1 hunks)\n* `src/RetrievalAugmentedGeneration/DocumentStores/HybridDocumentStore.cs` (1 hunks)\n* `src/RetrievalAugmentedGeneration/DocumentStores/InMemoryDocumentStore.cs` (5 hunks)\n* `src/RetrievalAugmentedGeneration/DocumentStores/MilvusDocumentStore.cs` (1 hunks)\n* `src/RetrievalAugmentedGeneration/DocumentStores/PineconeDocumentStore.cs` (1 hunks)\n* `src/RetrievalAugmentedGeneration/DocumentStores/PostgresVectorDocumentStore.cs` (1 hunks)\n* `src/RetrievalAugmentedGeneration/DocumentStores/QdrantDocumentStore.cs` (1 hunks)\n* `src/RetrievalAugmentedGeneration/DocumentStores/RedisVLDocumentStore.cs` (1 hunks)\n* `src/RetrievalAugmentedGeneration/DocumentStores/SQLiteVSSDocumentStore.cs` (1 hunks)\n* `src/RetrievalAugmentedGeneration/DocumentStores/WeaviateDocumentStore.cs` (1 hunks)\n\n</details>\n\n<details>\n<summary>≡ƒÜº Files skipped from review as they are similar to previous changes (1)</summary>\n\n* src/RetrievalAugmentedGeneration/DocumentStores/QdrantDocumentStore.cs\n\n</details>\n\n<details>\n<summary>≡ƒº░ Additional context used</summary>\n\n<details>\n<summary>≡ƒº¼ Code graph analysis (13)</summary>\n\n<details>\n<summary>src/RetrievalAugmentedGeneration/DocumentStores/SQLiteVSSDocumentStore.cs (4)</summary><blockquote>\n\n<details>\n<summary>src/RetrievalAugmentedGeneration/DocumentStores/DocumentStoreBase.cs (1)</summary>\n\n* `DocumentStoreBase` (29-381)\n\n</details>\n<details>\n<summary>src/RetrievalAugmentedGeneration/DocumentStores/AzureSearchDocumentStore.cs (7)</summary>\n\n* `AddCore` (42-51)\n* `Document` (110-113)\n* `AddBatchCore` (53-68)\n* `IEnumerable` (70-108)\n* `IEnumerable` (163-166)\n* `RemoveCore` (115-129)\n* `Clear` (193-198)\n\n</details>\n<details>\n<summary>src/RetrievalAugmentedGeneration/DocumentStores/RedisVLDocumentStore.cs (7)</summary>\n\n* `AddCore` (101-107)\n* `Document` (205-208)\n* `AddBatchCore` (132-141)\n* `IEnumerable` (172-187)\n* `IEnumerable` (265-268)\n* `RemoveCore` (228-231)\n* `Clear` (294-298)\n\n</details>\n<details>\n<summary>src/RetrievalAugmentedGeneration/Models/Document.cs (4)</summary>\n\n* `Document` (28-158)\n* `Document` (132-135)\n* `Document` (142-146)\n* `Document` (154-157)\n\n</details>\n\n</blockquote></details>\n<details>\n<summary>src/RetrievalAugmentedGeneration/DocumentStores/PineconeDocumentStore.cs (1)</summary><blockquote>\n\n<details>\n<summary>src/RetrievalAugmentedGeneration/DocumentStores/DocumentStoreBase.cs (1)</summary>\n\n* `DocumentStoreBase` (29-381)\n\n</details>\n\n</blockquote></details>\n<details>\n<summary>src/RetrievalAugmentedGeneration/DocumentStores/WeaviateDocumentStore.cs (1)</summary><blockquote>\n\n<details>\n<summary>src/RetrievalAugmentedGeneration/DocumentStores/DocumentStoreBase.cs (1)</summary>\n\n* `DocumentStoreBase` (29-381)\n\n</details>\n\n</blockquote></details>\n<details>\n<summary>src/RetrievalAugmentedGeneration/DocumentStores/InMemoryDocumentStore.cs (3)</summary><blockquote>\n\n<details>\n<summary>src/RetrievalAugmentedGeneration/DocumentStores/FAISSDocumentStore.cs (3)</summary>\n\n* `IEnumerable` (185-210)\n* `IEnumerable` (298-301)\n* `Document` (228-231)\n\n</details>\n<details>\n<summary>src/RetrievalAugmentedGeneration/DocumentStores/DocumentStoreBase.cs (8)</summary>\n\n* `IEnumerable` (83-86)\n* `IEnumerable` (95-102)\n* `IEnumerable` (135-138)\n* `IEnumerable` (207-207)\n* `IEnumerable` (254-254)\n* `Document` (109-113)\n* `Document` (219-219)\n* `Add` (50-54)\n\n</details>\n<details>\n<summary>src/RetrievalAugmentedGeneration/Models/Document.cs (4)</summary>\n\n* `Document` (28-158)\n* `Document` (132-135)\n* `Document` (142-146)\n* `Document` (154-157)\n\n</details>\n\n</blockquote></details>\n<details>\n<summary>src/RetrievalAugmentedGeneration/DocumentStores/AzureSearchDocumentStore.cs (2)</summary><blockquote>\n\n<details>\n<summary>src/RetrievalAugmentedGeneration/DocumentStores/DocumentStoreBase.cs (1)</summary>\n\n* `DocumentStoreBase` (29-381)\n\n</details>\n<details>\n<summary>src/RetrievalAugmentedGeneration/DocumentStores/QdrantDocumentStore.cs (8)</summary>\n\n* `HashSet` (233-262)\n* `AddCore` (41-50)\n* `Document` (110-113)\n* `AddBatchCore` (52-67)\n* `IEnumerable` (69-108)\n* `IEnumerable` (163-166)\n* `RemoveCore` (115-129)\n* `Clear` (194-199)\n\n</details>\n\n</blockquote></details>\n<details>\n<summary>src/RetrievalAugmentedGeneration/DocumentStores/ChromaDBDocumentStore.cs (2)</summary><blockquote>\n\n<details>\n<summary>src/RetrievalAugmentedGeneration/DocumentStores/DocumentStoreBase.cs (1)</summary>\n\n* `DocumentStoreBase` (29-381)\n\n</details>\n<details>\n<summary>src/RetrievalAugmentedGeneration/DocumentStores/ElasticsearchDocumentStore.cs (7)</summary>\n\n* `AddCore` (101-126)\n* `Document` (218-224)\n* `AddBatchCore` (128-159)\n* `IEnumerable` (161-216)\n* `IEnumerable` (299-302)\n* `RemoveCore` (250-261)\n* `Clear` (337-344)\n\n</details>\n\n</blockquote></details>\n<details>\n<summary>src/RetrievalAugmentedGeneration/DocumentStores/MilvusDocumentStore.cs (1)</summary><blockquote>\n\n<details>\n<summary>src/RetrievalAugmentedGeneration/DocumentStores/DocumentStoreBase.cs (1)</summary>\n\n* `DocumentStoreBase` (29-381)\n\n</details>\n\n</blockquote></details>\n<details>\n<summary>src/RetrievalAugmentedGeneration/DocumentStores/FAISSDocumentStore.cs (1)</summary><blockquote>\n\n<details>\n<summary>src/RetrievalAugmentedGeneration/DocumentStores/DocumentStoreBase.cs (10)</summary>\n\n* `DocumentStoreBase` (29-381)\n* `AddCore` (155-155)\n* `Document` (109-113)\n* `Document` (219-219)\n* `AddBatchCore` (176-182)\n* `MatchesFilters` (350-380)\n* `Add` (50-54)\n* `RemoveCore` (231-231)\n* `Remove` (120-124)\n* `Clear` (129-129)\n\n</details>\n\n</blockquote></details>\n<details>\n<summary>src/RetrievalAugmentedGeneration/DocumentStores/RedisVLDocumentStore.cs (4)</summary><blockquote>\n\n<details>\n<summary>src/RetrievalAugmentedGeneration/DocumentStores/DocumentStoreBase.cs (1)</summary>\n\n* `DocumentStoreBase` (29-381)\n\n</details>\n<details>\n<summary>src/RetrievalAugmentedGeneration/DocumentStores/AzureSearchDocumentStore.cs (7)</summary>\n\n* `AddCore` (42-51)\n* `Document` (110-113)\n* `AddBatchCore` (53-68)\n* `IEnumerable` (70-108)\n* `IEnumerable` (163-166)\n* `RemoveCore` (115-129)\n* `Clear` (193-198)\n\n</details>\n<details>\n<summary>src/RetrievalAugmentedGeneration/DocumentStores/SQLiteVSSDocumentStore.cs (7)</summary>\n\n* `AddCore` (102-108)\n* `Document` (209-212)\n* `AddBatchCore` (135-144)\n* `IEnumerable` (176-191)\n* `IEnumerable` (273-276)\n* `RemoveCore` (233-236)\n* `Clear` (307-311)\n\n</details>\n<details>\n<summary>src/RetrievalAugmentedGeneration/Models/Document.cs (4)</summary>\n\n* `Document` (28-158)\n* `Document` (132-135)\n* `Document` (142-146)\n* `Document` (154-157)\n\n</details>\n\n</blockquote></details>\n<details>\n<summary>src/RetrievalAugmentedGeneration/DocumentStores/ElasticsearchDocumentStore.cs (2)</summary><blockquote>\n\n<details>\n<summary>src/RetrievalAugmentedGeneration/DocumentStores/DocumentStoreBase.cs (1)</summary>\n\n* `DocumentStoreBase` (29-381)\n\n</details>\n<details>\n<summary>src/RetrievalAugmentedGeneration/DocumentStores/ChromaDBDocumentStore.cs (7)</summary>\n\n* `AddCore` (63-88)\n* `Document` (168-174)\n* `AddBatchCore` (90-115)\n* `IEnumerable` (117-166)\n* `IEnumerable` (247-250)\n* `RemoveCore` (195-212)\n* `Clear` (279-286)\n\n</details>\n\n</blockquote></details>\n<details>\n<summary>src/RetrievalAugmentedGeneration/DocumentStores/PostgresVectorDocumentStore.cs (1)</summary><blockquote>\n\n<details>\n<summary>src/RetrievalAugmentedGeneration/DocumentStores/DocumentStoreBase.cs (1)</summary>\n\n* `DocumentStoreBase` (29-381)\n\n</details>\n\n</blockquote></details>\n<details>\n<summary>src/RetrievalAugmentedGeneration/DocumentStores/DocumentStoreBase.cs (9)</summary><blockquote>\n\n<details>\n<summary>src/Helpers/MathHelper.cs (2)</summary>\n\n* `INumericOperations` (33-61)\n* `MathHelper` (16-987)\n\n</details>\n<details>\n<summary>src/RetrievalAugmentedGeneration/Retrievers/BM25Retriever.cs (4)</summary>\n\n* `T` (71-87)\n* `T` (89-103)\n* `IEnumerable` (31-69)\n* `MatchesFilters` (177-192)\n\n</details>\n<details>\n<summary>src/RetrievalAugmentedGeneration/Retrievers/MultiVectorRetriever.cs (1)</summary>\n\n* `T` (216-256)\n\n</details>\n<details>\n<summary>src/RetrievalAugmentedGeneration/DocumentStores/FAISSDocumentStore.cs (2)</summary>\n\n* `IEnumerable` (185-210)\n* `Document` (228-231)\n\n</details>\n<details>\n<summary>src/RetrievalAugmentedGeneration/DocumentStores/HybridDocumentStore.cs (3)</summary>\n\n* `IEnumerable` (183-222)\n* `IEnumerable` (299-302)\n* `Document` (242-245)\n\n</details>\n<details>\n<summary>src/RetrievalAugmentedGeneration/DocumentStores/InMemoryDocumentStore.cs (5)</summary>\n\n* `IEnumerable` (122-150)\n* `IEnumerable` (192-195)\n* `IEnumerable` (201-204)\n* `IEnumerable` (215-218)\n* `Document` (157-160)\n\n</details>\n<details>\n<summary>src/Interfaces/IDocumentStore.cs (1)</summary>\n\n* `Document` (165-165)\n\n</details>\n<details>\n<summary>src/RetrievalAugmentedGeneration/Models/Document.cs (4)</summary>\n\n* `Document` (28-158)\n* `Document` (132-135)\n* `Document` (142-146)\n* `Document` (154-157)\n\n</details>\n<details>\n<summary>src/RetrievalAugmentedGeneration/Retrievers/TFIDFRetriever.cs (2)</summary>\n\n* `Dictionary` (83-146)\n* `MatchesFilters` (148-163)\n\n</details>\n\n</blockquote></details>\n<details>\n<summary>src/RetrievalAugmentedGeneration/DocumentStores/HybridDocumentStore.cs (2)</summary><blockquote>\n\n<details>\n<summary>src/RetrievalAugmentedGeneration/DocumentStores/DocumentStoreBase.cs (15)</summary>\n\n* `DocumentStoreBase` (29-381)\n* `AddCore` (155-155)\n* `Add` (50-54)\n* `AddBatchCore` (176-182)\n* `AddBatch` (60-75)\n* `IEnumerable` (83-86)\n* `IEnumerable` (95-102)\n* `IEnumerable` (135-138)\n* `IEnumerable` (207-207)\n* `IEnumerable` (254-254)\n* `Document` (109-113)\n* `Document` (219-219)\n* `RemoveCore` (231-231)\n* `Remove` (120-124)\n* `Clear` (129-129)\n\n</details>\n<details>\n<summary>src/RetrievalAugmentedGeneration/Retrievers/HybridRetriever.cs (1)</summary>\n\n* `IEnumerable` (40-79)\n\n</details>\n\n</blockquote></details>\n\n</details>\n\n</details>\n\n<details>\n<summary>ΓÅ░ Context from checks skipped due to timeout of 90000ms. You can increase the timeout in your CodeRabbit configuration to a maximum of 15 minutes (900000ms). (1)</summary>\n\n* GitHub Check: Build All Frameworks\n\n</details>\n\n<details>\n<summary>≡ƒöç Additional comments (1)</summary><blockquote>\n\n<details>\n<summary>src/RetrievalAugmentedGeneration/DocumentStores/InMemoryDocumentStore.cs (1)</summary><blockquote>\n\n`122-150`: **Generic score propagation looks solid.**\n\nSwitching to `Document<T>` with the score typed as `T` keeps this store consistent with the base abstractions, and setting `HasRelevanceScore = true` on the returned instances matches what the other vector stores are doing. Nicely aligned update.\n\n</blockquote></details>\n\n</blockquote></details>\n\n</details>\n\n<!-- This is an auto-generated comment by CodeRabbit for review status -->",
  "submittedAt": "2025-11-05T15:09:20Z",
  "includesCreatedEdit": false,
  "reactionGroups": [],
  "state": "CHANGES_REQUESTED",
  "commit": {
    "oid": "e972697ed5a758045091402fb3f80cadcdfa8829"
  }
}
